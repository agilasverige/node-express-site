const program = [
  {
    "start": "2018-05-26T06:00:00.000Z",
    "stop": "2018-05-26T07:00:00.000Z",
    "activities": [{"room": "SPACE", "title": "Frukost", "speaker": ""}, {"room": "TAB", "title": "", "speaker": ""}]
  }
  ,
  {
    "start": "2018-05-26T07:00:00.000Z",
    "stop": "2018-05-26T07:10:00.000Z",
    "activities": [{"room": "SPACE", "title": "Intro till konferensen", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Pia, Jagge, Ola"
    }]
  }
  ,
  {
    "start": "2018-05-26T07:12:00.000Z",
    "stop": "2018-05-26T07:22:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Träffa Agiles hemliga kusin Design Thinking",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "Sigrun Tallungs"}]
  }
  ,
  {
    "start": "2018-05-26T07:24:00.000Z",
    "stop": "2018-05-26T07:34:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Teknik - vem får välja det och vem får leva med det?  ",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "Andreas Larsson"}]
  }
  ,
  {
    "start": "2018-05-26T07:36:00.000Z",
    "stop": "2018-05-26T07:46:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Strukturell dumhet - om när smarta människor blir en dum grupp",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "Anna Forss"}]
  }
  ,
  {
    "start": "2018-05-26T07:48:00.000Z",
    "stop": "2018-05-26T07:58:00.000Z",
    "activities": [{"room": "SPACE", "title": "Darwin hade varit agilist", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Carina Meurlinger"
    }]
  }
  ,
  {
    "start": "2018-05-26T07:58:00.000Z",
    "stop": "2018-05-26T08:20:00.000Z",
    "activities": [{"room": "SPACE", "title": "Rast", "speaker": ""}, {"room": "TAB", "title": "", "speaker": ""}]
  }
  ,
  {
    "start": "2018-05-26T08:20:00.000Z",
    "stop": "2018-05-26T08:30:00.000Z",
    "activities": [{"room": "SPACE", "title": "Arkitektur som bidrar till agilitet", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "David Sundelius"
    }]
  }
  ,
  {
    "start": "2018-05-26T08:32:00.000Z",
    "stop": "2018-05-26T08:42:00.000Z",
    "activities": [{"room": "SPACE", "title": "Så glada att vi vågade self selection!", "speaker": ""}, {
      "room": "TAB",
      "title": "OM mitt tal kommer med så talar jag gärna på förmiddagen :)",
      "speaker": "Linn Keife"
    }]
  }
  ,
  {
    "start": "2018-05-26T08:44:00.000Z",
    "stop": "2018-05-26T08:54:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Organisations-psykologiska utmaningar vid agil transformation",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "Håkan Lövén"}]
  }
  ,
  {
    "start": "2018-05-26T08:56:00.000Z",
    "stop": "2018-05-26T09:06:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Vi är agila, men vår arkitektur är gjuten i betong :-(",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "Jan Grape"}]
  }
  ,
  {
    "start": "2018-05-26T09:08:00.000Z",
    "stop": "2018-05-26T09:18:00.000Z",
    "activities": [{"room": "SPACE", "title": "Led hjärnan rätt", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Jenny Höglund Svensson"
    }]
  }
  ,
  {
    "start": "2018-05-26T09:18:00.000Z",
    "stop": "2018-05-26T09:28:00.000Z",
    "activities": [{"room": "SPACE", "title": "Rast", "speaker": ""}, {"room": "TAB", "title": "", "speaker": ""}]
  }
  ,
  {
    "start": "2018-05-26T09:28:00.000Z",
    "stop": "2018-05-26T09:38:00.000Z",
    "activities": [{"room": "SPACE", "title": "Våga experimentera & visualisera!", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Eva Mattsson & Ingela Strandh"
    }]
  }
  ,
  {
    "start": "2018-05-26T09:40:00.000Z",
    "stop": "2018-05-26T09:50:00.000Z",
    "activities": [{"room": "SPACE", "title": "Kan statisk typning vara Agilt?", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Joakim Ohlrogge"
    }]
  }
  ,
  {
    "start": "2018-05-26T09:52:00.000Z",
    "stop": "2018-05-26T10:02:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Hur jag effektivt gjorde alla stakeholders besvikna, och hur en donut blev räddningen",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "Joel  Sanderi"}]
  }
  ,
  {
    "start": "2018-05-26T10:02:00.000Z",
    "stop": "2018-05-26T11:00:00.000Z",
    "activities": [{"room": "SPACE", "title": "Lunch", "speaker": ""}, {"room": "TAB", "title": "", "speaker": ""}]
  }
  ,
  {
    "start": "2018-05-26T11:00:00.000Z",
    "stop": "2018-05-26T11:40:00.000Z",
    "activities": [{"room": "SPACE", "title": "Open Space och Workshop Introduktion", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": ""
    }]
  }
  ,
  {
    "start": "2018-05-26T11:40:00.000Z",
    "stop": "2018-05-26T12:25:00.000Z",
    "activities": [{"room": "SPACE", "title": "Open Space Pass 1", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": ""
    }]
  }
  ,
  {
    "start": "2018-05-26T12:25:00.000Z",
    "stop": "2018-05-26T12:40:00.000Z",
    "activities": [{"room": "SPACE", "title": "Rast", "speaker": ""}, {"room": "TAB", "title": "", "speaker": ""}]
  }
  ,
  {
    "start": "2018-05-26T12:40:00.000Z",
    "stop": "2018-05-26T13:25:00.000Z",
    "activities": [{"room": "SPACE", "title": "Open Space Pass 2", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": ""
    }]
  }
  ,
  {
    "start": "2018-05-26T13:25:00.000Z",
    "stop": "2018-05-26T13:40:00.000Z",
    "activities": [{"room": "SPACE", "title": "Fika", "speaker": ""}, {"room": "TAB", "title": "", "speaker": ""}]
  }
  ,
  {
    "start": "2018-05-26T13:40:00.000Z",
    "stop": "2018-05-26T13:50:00.000Z",
    "activities": [{"room": "SPACE", "title": "\"Tre sorters agila förändringsledare”", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Esbjörn Hyltefors"
    }]
  }
  ,
  {
    "start": "2018-05-26T13:52:00.000Z",
    "stop": "2018-05-26T14:02:00.000Z",
    "activities": [{"room": "SPACE", "title": "Oops we did it again", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Magnus Tholén"
    }]
  }
  ,
  {
    "start": "2018-05-26T14:04:00.000Z",
    "stop": "2018-05-26T14:14:00.000Z",
    "activities": [{"room": "SPACE", "title": "Teaching agile post waterfall", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Markus Elving"
    }]
  }
  ,
  {
    "start": "2018-05-26T14:16:00.000Z",
    "stop": "2018-05-26T14:26:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Agile Governance - Att fostra en agil kultur",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "Matti Klasson"}]
  }
  ,
  {
    "start": "2018-05-26T14:28:00.000Z",
    "stop": "2018-05-26T14:38:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Trust - a foundation for successful agile transformations?",
      "speaker": ""
    }, {
      "room": "TAB",
      "title": "Om mitt tal kommer med, är jag tacksam om det inte blir tidigt dag 1 eller sent dag 2 pga resa.",
      "speaker": "Inga-Lill Holmqvist"
    }]
  }
  ,
  {
    "start": "2018-05-26T14:40:00.000Z",
    "stop": "2018-05-26T14:50:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Kejsaren är naken! Om att leka chef på jobbet",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "Victoria Normark"}]
  }
  ,
  {
    "start": "2018-05-26T14:52:00.000Z",
    "stop": "2018-05-26T15:02:00.000Z",
    "activities": [{"room": "SPACE", "title": "Hur stoppar vi den agila arenarocken?", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Marcus Ahnve"
    }]
  }
  ,
  {
    "start": null,
    "stop": null,
    "activities": [{"room": "SPACE", "title": "Mingel", "speaker": ""}, {"room": "TAB", "title": "", "speaker": ""}]
  }
  ,
  {
    "start": "2018-05-27T07:00:00.000Z",
    "stop": "2018-05-27T07:10:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Hur gör du för att förstå dina användare?",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "My Amori"}]
  }
  ,
  {
    "start": "2018-05-27T07:12:00.000Z",
    "stop": "2018-05-27T07:22:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Lean UX - maximera lärandet och bygg innovation",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "Johanna Olander"}]
  }
  ,
  {
    "start": "2018-05-27T07:24:00.000Z",
    "stop": "2018-05-27T07:34:00.000Z",
    "activities": [{"room": "SPACE", "title": "Agile UX - Från Design Sprints till Mob", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Martin Christensen"
    }]
  }
  ,
  {
    "start": "2018-05-27T07:36:00.000Z",
    "stop": "2018-05-27T07:46:00.000Z",
    "activities": [{"room": "SPACE", "title": "Trender som exkluderar", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Hampus Sethfors"
    }]
  }
  ,
  {
    "start": "2018-05-27T07:48:00.000Z",
    "stop": "2018-05-27T07:58:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Strategisk produktutveckling i en föränderlig miljö",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "Nina Boljang"}]
  }
  ,
  {
    "start": "2018-05-27T07:58:00.000Z",
    "stop": "2018-05-27T08:20:00.000Z",
    "activities": [{"room": "SPACE", "title": "Rast", "speaker": ""}, {"room": "TAB", "title": "", "speaker": ""}]
  }
  ,
  {
    "start": "2018-05-27T08:20:00.000Z",
    "stop": null,
    "activities": [{
      "room": "SPACE",
      "title": "Engagerade teammöten - Lean Coffee Style",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "David Asarnoj"}]
  }
  ,
  {
    "start": "2018-05-27T08:32:00.000Z",
    "stop": "2018-05-27T08:42:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Schimpanser, Scaled agile och Scanias Servicemarknadverktyg",
      "speaker": ""
    }, {"room": "TAB", "title": "Kan bara på torsdagen", "speaker": "Ola Ramström"}]
  }
  ,
  {
    "start": "2018-05-27T08:44:00.000Z",
    "stop": "2018-05-27T08:54:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Little’s lag – en liten lag om flöde med stora implikationer",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "Pontus Bergöö"}]
  }
  ,
  {
    "start": "2018-05-27T08:56:00.000Z",
    "stop": "2018-05-27T09:06:00.000Z",
    "activities": [{"room": "SPACE", "title": "The ASS! (animated system status)", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Robin Bergh"
    }]
  }
  ,
  {
    "start": "2018-05-27T09:08:00.000Z",
    "stop": "2018-05-27T09:18:00.000Z",
    "activities": [{"room": "SPACE", "title": "Minimum Viable Security", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Sebastian Åkerman"
    }]
  }
  ,
  {
    "start": "2018-05-27T09:18:00.000Z",
    "stop": "2018-05-27T09:30:00.000Z",
    "activities": [{"room": "SPACE", "title": "Rast", "speaker": ""}, {"room": "TAB", "title": "", "speaker": ""}]
  }
  ,
  {
    "start": "2018-05-27T09:30:00.000Z",
    "stop": "2018-05-27T09:40:00.000Z",
    "activities": [{"room": "SPACE", "title": "Rapport från kanten av min förmåga", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Thomas Svensson"
    }]
  }
  ,
  {
    "start": "2018-05-27T09:42:00.000Z",
    "stop": "2018-05-27T09:52:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Skala upp med ramverk eller verktygslåda?",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "Fredrik Viljesjö"}]
  }
  ,
  {
    "start": "2018-05-27T09:54:00.000Z",
    "stop": "2018-05-27T10:04:00.000Z",
    "activities": [{
      "room": "SPACE",
      "title": "Jesusbarnet och stjärnan -- men *när* är ni klara?",
      "speaker": ""
    }, {"room": "TAB", "title": "", "speaker": "Staffan Nöteberg"}]
  }
  ,
  {
    "start": "2018-05-27T10:04:00.000Z",
    "stop": "2018-05-27T11:00:00.000Z",
    "activities": [{"room": "SPACE", "title": "Lunch", "speaker": ""}, {"room": "TAB", "title": "", "speaker": ""}]
  }
  ,
  {
    "start": "2018-05-27T11:00:00.000Z",
    "stop": "2018-05-27T11:25:00.000Z",
    "activities": [{"room": "SPACE", "title": "Open Space och Workshop Introduktion", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": ""
    }]
  }
  ,
  {
    "start": "2018-05-27T11:25:00.000Z",
    "stop": "2018-05-27T12:10:00.000Z",
    "activities": [{"room": "SPACE", "title": "Open Space Pass 1", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Du?"
    }]
  }
  ,
  {
    "start": "2018-05-27T12:10:00.000Z",
    "stop": "2018-05-27T12:25:00.000Z",
    "activities": [{"room": "SPACE", "title": "Rast", "speaker": ""}, {"room": "TAB", "title": "", "speaker": ""}]
  }
  ,
  {
    "start": "2018-05-27T12:25:00.000Z",
    "stop": "2018-05-27T13:10:00.000Z",
    "activities": [{"room": "SPACE", "title": "Open Space Pass 2", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Du?"
    }]
  }
  ,
  {
    "start": "2018-05-27T13:10:00.000Z",
    "stop": "2018-05-27T13:30:00.000Z",
    "activities": [{"room": "SPACE", "title": "Fika", "speaker": ""}, {"room": "TAB", "title": "", "speaker": ""}]
  }
  ,
  {
    "start": "2018-05-27T13:30:00.000Z",
    "stop": "2018-05-27T13:40:00.000Z",
    "activities": [{"room": "SPACE", "title": "Sluta försöka testa in kvalité!", "speaker": ""}, {
      "room": "TAB",
      "title": "",
      "speaker": "Tobbe Gyllebring"
    }]
  }
  ,
  {
    "start": "2018-05-27T13:42:00.000Z",
    "stop": "2018-05-27T13:52:00.000Z",
    "activities": [{"room": "SPACE", "title": "Återblick", "speaker": ""}, {"room": "TAB", "title": "", "speaker": ""}]
  }
];

const weekdays = [ 'söndag', 'måndag', 'tisdag', 'onsdag', 'torsdag', 'fredag', 'lördag' ]

$.get("./program.json", function (program) {
  $.get("./descriptions.json", function (descriptions) {

    const indexedDescriptions = descriptions.reduce(function (index, description) {
      index[description.title] = description;
      return index;
    }, {});

    function addDescriptions(program) {
      return program
        .map((slot) => {
          slot.activities = slot.activities.map((activity) => {
            const description = indexedDescriptions[activity.title];
            activity.description = description ? description.description : '';
            return activity;
          });
          return slot;
        });
    }

    Handlebars.registerHelper('timestamp', function (dateString) {
      return Date.parse(dateString);
    });

    Handlebars.registerHelper('localDate', function (dateString) {

      const dayOfWeek = new Date(Date.parse(dateString)).getDay();
      return weekdays[dayOfWeek];
    });

    Handlebars.registerHelper('localTime', function (dateString) {
      const date = new Date(Date.parse(dateString));
      return date ? date.toLocaleTimeString().split(':').slice(0, 2).join(':') : '';
    });

    const source = document.getElementById("program-template").innerHTML;
    const template = Handlebars.compile(source);

    const programWithDescriptions = addDescriptions(program);
    const programDay1 = programWithDescriptions.filter((slot) => Date.parse(slot.start) < Date.parse('2018-05-31'));
    const programDay2 = programWithDescriptions.filter((slot) => Date.parse(slot.start) >= Date.parse('2018-05-31'));

    const day1Html = template({slots: programDay1});
    const day2Html = template({slots: programDay2});

    document.getElementById("program-day-1").innerHTML = day1Html;
    document.getElementById("program-day-2").innerHTML = day2Html;

    const startTimes = program.map(slot => Date.parse(slot.start));

    function findCurrentAndNext(now) {

      const nextIndex = startTimes.findIndex((timestamp) => timestamp >= now);
      if (nextIndex > 0) {
        return { current: startTimes[nextIndex - 1], next: startTimes[nextIndex] };
      }
      return { current: 0, next: 0 };
    }

    function markCurrentSlot() {
      const now = new Date();
      now.setDate(30);
      now.setHours(12);
      const currentAndNext = findCurrentAndNext(now);

      $('.current').removeClass('current');
      $('.next').removeClass('next');
      const current = $('[data-start-time=' + currentAndNext.current + ']').addClass('current').get(0);
      $('[data-start-time=' + currentAndNext.next + ']').addClass('next');
      if (current) {
        current.scrollIntoView();
      }
    }

    markCurrentSlot();
    window.setInterval(markCurrentSlot, 60000);
  });
});


